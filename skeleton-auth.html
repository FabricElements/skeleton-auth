<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-styles/classes/typography.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="./auth-mixin.html">
<link rel="import" href="./icons.html">

<dom-module id="skeleton-auth">
  <template strip-whitespace>
    <style is="custom-style">
      :host {
        display: block;
        overflow-y: auto;
        margin: 0 1rem;
        padding: 1rem 0;
        --login-button: {
        };
      }

      a {
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      paper-button {
        @apply --auth-button;
      }

      paper-button:not([disabled]) {
        color: white;
      }

      paper-button:last-child {
        margin-bottom: 0;
      }

      paper-button.google:not([disabled]) {
        background: var(--button-google-color, var(--paper-red-a200));
      }

      paper-button.facebook:not([disabled]) {
        background: var(--button-facebook-color, var(--paper-indigo-a200));
      }

      paper-button.twitter:not([disabled]) {
        background: var(--button-twitter-color, var(--paper-blue-a200));
      }

      paper-button.phone:not([disabled]) {
        background: var(--button-twitter-color, var(--paper-blue-a200));
      }

      paper-button.github:not([disabled]) {
        background: var(--button-github-color, var(--paper-grey-900));
      }

      paper-button.anonymous:not([disabled]) {
        background: var(--button-anonymous-color, var(--paper-grey-700));
      }

      paper-button.email:not([disabled]) {
        background: var(--button-email-color, var(--paper-grey-800));
      }

      paper-button iron-icon {
        margin-right: 10px;
        --iron-icon-size: 16px;
      }

      paper-button span {
        vertical-align: middle;
        text-transform: none;
      }

      #email-login {
        text-align: left;
        margin-bottom: 4rem;
      }

      hr {
        border: 1px solid var(--divider-color, #FAFAFA);
        margin: 4rem 0 2rem 0;
      }

      .m-b-1 {
        margin-bottom: 1rem;
      }

      #auth-container {
        overflow: hidden;
      }

      .screen {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: opacity 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: max-height, opacity;
      }

      .options-open #options-box,
      .email-login-open #email-login-box,
      .email-providers-open #email-providers-box,
      .email-signup-open #email-signup-box,
      .forgot-pass-open #forgot-pass-box,
      .email-sent-open #email-sent-box,
      .phone-login-open #phone-login-box,
      .confirm-code-open #confirm-code-box {
        max-height: 1000px;
        opacity: 1;
      }

    </style>

    <div id="auth-container" class$="[[openView]]-open">
      <nav id="options-box" class="screen">
        <template is="dom-if" if="[[google]]">
          <paper-button class="google" on-tap="signInGoogle">
            <iron-icon icon="auth:google"></iron-icon>
            Google
          </paper-button>
        </template>

        <template is="dom-if" if="[[facebook]]">
          <paper-button class="facebook" on-tap="signInFacebook">
            <iron-icon icon="auth:facebook"></iron-icon>
            Facebook
          </paper-button>
        </template>

        <template is="dom-if" if="[[twitter]]">
          <paper-button class="twitter" on-tap="signInTwitter">
            <iron-icon icon="auth:twitter"></iron-icon>
            Twitter
          </paper-button>
        </template>

        <template is="dom-if" if="[[github]]">
          <paper-button class="github" on-tap="signInGitHub">
            <iron-icon icon="auth:github"></iron-icon>
            GitHub
          </paper-button>
        </template>

        <template is="dom-if" if="[[anonymous]]">
          <paper-button class="anonymous" on-tap="signInAnonymously">
            <iron-icon icon="auth:person-outline"></iron-icon>
            Anonymous
          </paper-button>
        </template>

        <template is="dom-if" if="[[phone]]">
          <paper-button class="phone" on-tap="_choosePhone">
            <iron-icon icon="auth:person-outline"></iron-icon>
            Phone Number
          </paper-button>
        </template>

        <template is="dom-if" if="[[email]]">
          <paper-button class="email" on-tap="_chooseEmail">
            <iron-icon icon="auth:email"></iron-icon>
            Email
          </paper-button>
        </template>
      </nav>

      <!--
        Phone Login screen
      -->
      <template is="dom-if" if="[[phone]]">
        <div id="phone-login-box" class="screen">
          <iron-form id="phone-login-form">
            <form on-submit="signInWithPhone" onkeyup="[[_submitOnEnter]]">

              <iron-ajax
                auto
                url="../dialing-codes.json"
                handle-as="json"
                last-response={{dataCodes}}
              ></iron-ajax>

              <paper-dropdown-menu value="{{phoneCode}}" label="Dialing Codes">
                <paper-listbox attr-for-selected="label" slot="dropdown-content" class="dropdown-content">
                    <template is="dom-repeat" items="{{dataCodes}}">
                        <paper-item label$="[[item.phoneCode]]">
                          [[item.countryName]] [[item.phoneCode]]
                        </paper-item>
                    </template>
                </paper-listbox>
              </paper-dropdown-menu>

              <paper-input value="{{phoneNumber}}"
                            label="Phone number"
                            type="text"
                            class="m-b-1"
              ></paper-input>
              <paper-button id="sign-in-button" class="email" on-tap="signInWithPhone">
                <span>
                  Verify
                </span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Phone code verification screen
      -->
      <template is="dom-if" if="[[phone]]">
        <div id="confirm-code-box" class="screen">
          <iron-form id="confirm-code-form">
            <form on-submit="confirmCode" onkeyup="[[_submitOnEnter]]">
              <paper-input value="{{confirmationCode}}"
                            label="6-digit code"
                            type="text"
                            class="m-b-1"
              ></paper-input>
              <paper-button class="email" on-tap="confirmCode">
                <span>Continue</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Email/Password Login screen
      -->
      <template is="dom-if" if="[[email]]">
        <div id="email-login-box" class="screen">
          <iron-form id="email-login-form">
            <form on-submit="fetchEmailProviders" onkeyup="[[_submitOnEnter]]">
              <paper-input 
                value="{{userEmail}}" 
                id="login-input-mail" 
                required 
                auto-validate 
                error-message="[[errorMessageEmail]]"
                label="[[labelEmail]]"
                type="email" 
                class="m-b-1">
              </paper-input>

              <paper-button class="email" on-tap="fetchEmailProviders">
                <span>Sign in</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Email available providers screen
      -->
      <template is="dom-if" if="[[email]]">
        <div id="email-providers-box" class="screen">
          <nav id="providers">
            <template is="dom-if" if="[[availableProviders.google]]">
              <paper-button class="google" on-tap="signInGoogle">
                <iron-icon icon="auth:google"></iron-icon>
                Google
              </paper-button>
            </template>

            <template is="dom-if" if="[[availableProviders.facebook]]">
              <paper-button class="facebook" on-tap="signInFacebook">
                <iron-icon icon="auth:facebook"></iron-icon>
                Facebook
              </paper-button>
            </template>

            <template is="dom-if" if="[[availableProviders.twitter]]">
              <paper-button class="twitter" on-tap="signInTwitter">
                <iron-icon icon="auth:twitter"></iron-icon>
                Twitter
              </paper-button>
            </template>

            <template is="dom-if" if="[[availableProviders.github]]">
              <paper-button class="github" on-tap="signInGitHub">
                <iron-icon icon="auth:github"></iron-icon>
                GitHub
              </paper-button>
            </template>
          </nav>

          <template is="dom-if" if="[[availableProviders.password]]">
            <iron-form id="password-login-box">
              <form on-submit="signInWithEmailAndPassword" onkeyup="[[_submitOnEnter]]">
                <paper-input value="{{userEmail}}"
                  disabled="[[disabled]]"
                  type="email"
                  class="m-b-1"
                ></paper-input>
                <paper-input 
                  value="{{userPassword}}"
                  id="login-input-pass"
                  label="[[labelPassSignIn]]"
                  type="password"
                  class="m-b-1"
                ></paper-input>

                <a href on-click="_forgotPass">Forgot Your Password?</a>

                <paper-button class="email" on-tap="signInWithEmailAndPassword">
                  <span>Sign in</span>
                </paper-button>
              </form>
            </iron-form>
          </template>

          <paper-button class="email" on-tap="_closeDialog">
            <span>Cancel</span>
          </paper-button>
        </div>
      </template>

      <!--
        Recover password screen
      -->
      <template is="dom-if" if="[[email]]">
        <div id="forgot-pass-box" class="screen">
          <iron-form id="forgot-pass-form">
            <form>

              <h3>Recover password</h3>

              <p>Get instructions sent to this email that explain how to reset your password</p>

              <paper-input value="{{userEmail}}"
                            type="text"
                            class="m-b-1"
              ></paper-input>

              <paper-button class="email" on-tap="passwordReset">
                <span>Send</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Email sent verification screen
      -->
      <template is="dom-if" if="[[email]]">
        <div id="email-sent-box" class="screen">
          <h3>Check your email</h3>

          <p>Follow the instructions sent to <strong>[[userEmail]]</strong> to recover your password.</p>

          <paper-button class="email" on-tap="_chooseEmail">
            <span>Done</span>
          </paper-button>
        </div>
      </template>

      <!--
        Email Sign-up screen
      -->
      <template is="dom-if" if="[[email]]">
        <div id="email-signup-box" class="screen">
          <iron-form id="email-signup-form">
            <form on-submit="createUserWithEmailAndPassword" onkeyup="[[_submitOnEnter]]">
              <paper-input value="{{userEmail}}"
                            class="m-b-1"
                            disabled="[[disabled]]"
                            type="email">
              </paper-input>

              <paper-input value="{{userName}}" 
                            auto-validate 
                            class="m-b-1"
                            id="signup-input-name"
                            label="First & last name"
                            required
                            type="text">
              </paper-input>

              <paper-input value="{{userPassword}}"
                            auto-validate
                            id="signup-input-pass"
                            class="m-b-1"
                            error-message="[[errorMessagePass]]"
                            label="[[labelPassSignUp]]"
                            minlength="[[minLength]]"
                            required
                            type="password">
              </paper-input>

              <paper-button class="email" on-tap="createUserWithEmailAndPassword">
                <span>Sign Up</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>
    </div>
  </template>

  <script>
    /**
     * `skeleton-auth`
     * Minimal Sign in module using polymer and firebase
     *
     * @customElement
     * @polymer
     * @constructor
     * @appliesMixin Fabric.AuthMixin
     * @extends Polymer.Element
     * @property {boolean} google
     * @demo demo/index.html
     * */
    class SkeletonAuth extends Fabric.AuthMixin(Polymer.Element) {
      /**
       * @return {string}
       */
      static get is() {
        return 'skeleton-auth';
      }

      /**
       * Constructor
       */
      constructor() {
        super();
      }

      /**
       * @return {object}
       */
      static get properties() {
        return {
          /*
           * Currently open view.
           */
          openView: {
            type: String,
            value: 'options',
          },

          /*
           * Error listener.
           */
          onError: {
            type: Function,
          },

          /*
           * Available providers for the given email.
           */
          availableProviders: {
            type: Array,
            value: [],
            notify: true,
          },

          /*
           * The label for the email input.
           */
          labelEmail: {
            type: String,
            value: 'email@example.com',
          },

          /*
           * The label for the sign in password input.
           */
          labelPassSignIn: {
            type: String,
            value: 'Password input',
          },

          /*
           * The label for the sign up password input.
           */
          labelPassSignUp: {
            type: String,
            value: 'Choose password',
          },

          /*
           * The minimum length of the input value.
           */
          minLength: {
            type: Number,
            value: 6,
          },

          /*
           * The error message to display when the email input is invalid.
           */
          errorMessageEmail: {
            type: String,
            value: 'Please enter a valid email',
          },

          /*
           * The error message to display when the password input is invalid.
           */
           errorMessagePass: {
            type: String,
            value: 'Password should be at least 6 characters',
          },

          /*
           * Disable email input on sign-up form
           */
          disabled: {
            type: Boolean,
            value: true,
          },

          userEmail: {
            type: String,
            value: null,
          },

          userPassword: {
            type: String,
            value: null,
          },

          phoneNumber: {
            type: String,
            value: null,
          },

          phoneCode: {
            type: String,
            value: null,
          },

          confirmationCode: {
            type: String,
            value: null,
          },

          userName: {
            type: String,
            value: null,
          },

          recaptchaContainer: {
            type: String,
            value: null,
          },
        };
      }

      /**
       * Call to open the email dialog
       *
       * @private
       */
      _chooseEmail() {
        this.openView = 'email-login';
      }

      /**
       * Call to open the phone dialog
       *
       * @private
       */
       _choosePhone() {
        this.openView = 'phone-login';
      }

      /**
       * Call to open the forgot password dialog
       *
       * @param {Object} e
       * @private
       */
       _forgotPass(e) {
         e.preventDefault();
        this.openView = 'forgot-pass';
      }

      /**
       * Call to close the email dialog
       *
       * @private
       */
      _closeDialog() {
        this.openView = 'options';
      }
    }

    window.customElements.define(SkeletonAuth.is, SkeletonAuth);
  </script>

</dom-module>
