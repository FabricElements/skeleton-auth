<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../paper-styles/classes/typography.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/maps-icons.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="./auth-mixin.html">
<link rel="import" href="./icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<dom-module id="skeleton-auth">
  <template strip-whitespace>
    <!--suppress CssInvalidPseudoSelector -->
    <!--suppress CssUnresolvedCustomProperty -->
    <!--suppress CssUnresolvedCustomPropertySet -->
    <style is="custom-style">
      :host {
        display: block;
        box-sizing: border-box;
        padding: 1rem 0;
        --login-button: {
        };
      }

      :host * {
        box-sizing: border-box;
      }

      a {
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      paper-button {
        @apply --auth-button;
      }

      paper-button:not([disabled]) {
        color: white;
      }

      paper-button:last-child {
        margin-bottom: 0;
      }

      paper-button.google:not([disabled]) {
        background: var(--button-google-color, var(--paper-red-a200));
      }

      paper-button.facebook:not([disabled]) {
        background: var(--button-facebook-color, var(--paper-indigo-a200));
      }

      paper-button.twitter:not([disabled]) {
        background: var(--button-twitter-color, var(--paper-blue-a200));
      }

      paper-button.phone:not([disabled]) {
        background: var(--button-twitter-color, var(--paper-blue-a200));
      }

      paper-button.github:not([disabled]) {
        background: var(--button-github-color, var(--paper-grey-900));
      }

      paper-button.anonymous:not([disabled]) {
        background: var(--button-anonymous-color, var(--paper-grey-700));
      }

      paper-button.email:not([disabled]) {
        background: var(--button-email-color, var(--paper-grey-800));
      }

      paper-button iron-icon {
        margin-right: 10px;
        --iron-icon-size: 16px;
      }

      paper-button span {
        vertical-align: middle;
        text-transform: uppercase;
      }

      .custom-select {
        display: block;
        padding: 8px 0;        
        margin-right: 20px;
        max-width: 90px;
        position: relative;
        text-align: center;
      }

      .custom-select > .custom-select-label {
        display: inline-block;
        line-height: 1.5;
        border-bottom: 1px solid var(--paper-input-container-color, var(--secondary-text-color));
        width: 90px;
      }

      .custom-select > .custom-select-label:empty::after {
        display: inline-block;
      }

      .arrow-down-icon {
        float: right;
      }

      .custom-select > select {
        background: none;
        border: none;
        bottom: 0;
        cursor: pointer;
        left: 0;
        opacity: 0;
        position: absolute;
        right: 0;
        top: 0;
      }

      .custom-select > select:focus {
        outline: none;
      }

      .phone-number {
        width: 100%;
        align-items: flex-end;
        @apply --layout-inline;
      }

      #phone-input {
        @apply --layout-flex-auto;
      }

      #email-login {
        text-align: left;
        margin-bottom: 4rem;
      }

      hr {
        border: 1px solid var(--divider-color, #FAFAFA);
        margin: 4rem 0 2rem 0;
      }

      .m-b-1 {
        margin-bottom: 1rem;
      }

      iron-pages,
      iron-pages > * {
        position: relative;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        width: 100%;
        min-height: 100%;
        display: block;
        animation-fill-mode: both;
        animation-name: fadeOut;
        animation-duration: 2s;
        @apply --layout-flex-auto;
        @apply --layout-vertical;
      }

      iron-pages > :not([selected]) > * {
        display: none;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      .fadeIn,
      iron-pages > [selected],
      :not([hidden]) {
        animation-name: fadeIn;
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }

        to {
          opacity: 0;
        }
      }

      .fadeOut,
      [hidden] {
        animation-name: fadeOut;
      }
    </style>

    <iron-pages id="pages"
                selected="{{selected}}"
                attr-for-selected="name"
                selected-attribute="selected"
                fallback-selection="options"
                role="navigation">
      <nav name="options">
        <template is="dom-if" if="[[google]]">
          <paper-button class="google" on-tap="signInGoogle">
            <iron-icon icon="auth:google"></iron-icon>
            Google
          </paper-button>
        </template>

        <template is="dom-if" if="[[facebook]]">
          <paper-button class="facebook" on-tap="signInFacebook">
            <iron-icon icon="auth:facebook"></iron-icon>
            Facebook
          </paper-button>
        </template>

        <template is="dom-if" if="[[twitter]]">
          <paper-button class="twitter" on-tap="signInTwitter">
            <iron-icon icon="auth:twitter"></iron-icon>
            Twitter
          </paper-button>
        </template>

        <template is="dom-if" if="[[github]]">
          <paper-button class="github" on-tap="signInGitHub">
            <iron-icon icon="auth:github"></iron-icon>
            GitHub
          </paper-button>
        </template>

        <template is="dom-if" if="[[anonymous]]">
          <paper-button class="anonymous" on-tap="signInAnonymously">
            <iron-icon icon="auth:person-outline"></iron-icon>
            Anonymous
          </paper-button>
        </template>

        <template is="dom-if" if="[[phone]]">
          <paper-button class="phone" on-tap="_choosePhone">
            <iron-icon icon="auth:person-outline"></iron-icon>
            Phone Number
          </paper-button>
        </template>

        <template is="dom-if" if="[[email]]">
          <paper-button class="email" on-tap="_chooseEmail">
            <iron-icon icon="auth:email"></iron-icon>
            Email
          </paper-button>
        </template>
      </nav>

      <!--
        Phone Login screen
      -->
      <template is="dom-if" if="[[phone]]">
        <div name="phone-login">
          <iron-form id="phone-login-form">
            <form on-submit="signInWithPhone" onkeyup="[[_submitOnEnter]]">
              <div class="phone-number">
                <label class="custom-select" for="phone-code-select">
                  <span class="custom-select-label">
                    [[phoneCode]] 
                    <iron-icon class="arrow-down-icon" icon="icons:arrow-drop-down"></iron-icon>
                  </span>
                  <select value="{{phoneCode::change}}" id="phone-code-select">
                    <template is="dom-repeat" items="[[dialingCodes]]">
                      <option value="[[item.phoneCode]]">
                        [[item.countryName]] [[item.phoneCode]]
                      </option>
                    </template>
                  </select>
                </label>

                <paper-input value="{{phoneNumber}}"
                             allowed-pattern="[\d]"
                             id="phone-input"
                             label="Phone number"
                             prevent-invalid-input
                             type="number"
                             type="text"
                ></paper-input>
              </div>
              <paper-button id="sign-in-button" class="email" on-tap="signInWithPhone">
                <span>
                  Verify
                </span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Phone code verification screen
      -->
      <template is="dom-if" if="[[phone]]">
        <div name="confirm-code">
          <iron-form id="confirm-code-form">
            <form on-submit="confirmCode" onkeyup="[[_submitOnEnter]]">
              <paper-input value="{{confirmationCode}}"
                           class="m-b-1"
                           label="6-digit code"
                           type="text"
              ></paper-input>
              <paper-button class="email" on-tap="confirmCode">
                <span>Continue</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Email/Password Login screen
      -->
      <template is="dom-if" if="[[email]]">
        <div name="email-login">
          <iron-form id="email-login-form">
            <form on-submit="fetchEmailProviders" onkeyup="[[_submitOnEnter]]">
              <paper-input value="{{userEmail}}"
                           id="login-input-mail"
                           required
                           auto-validate$="[[userEmail]]"
                           error-message="[[errorMessageEmail]]"
                           label="[[labelEmail]]"
                           type="email"
                           class="m-b-1"
              ></paper-input>

              <paper-button class="email" on-tap="fetchEmailProviders">
                <span>Sign In</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Email available providers screen
      -->
      <template is="dom-if" if="[[email]]">
        <div name="email-providers">
          <nav id="providers">
            <template is="dom-if" if="[[availableProviders.google]]">
              <paper-button class="google" on-tap="signInGoogle">
                <iron-icon icon="auth:google"></iron-icon>
                Google
              </paper-button>
            </template>

            <template is="dom-if" if="[[availableProviders.facebook]]">
              <paper-button class="facebook" on-tap="signInFacebook">
                <iron-icon icon="auth:facebook"></iron-icon>
                Facebook
              </paper-button>
            </template>

            <template is="dom-if" if="[[availableProviders.twitter]]">
              <paper-button class="twitter" on-tap="signInTwitter">
                <iron-icon icon="auth:twitter"></iron-icon>
                Twitter
              </paper-button>
            </template>

            <template is="dom-if" if="[[availableProviders.github]]">
              <paper-button class="github" on-tap="signInGitHub">
                <iron-icon icon="auth:github"></iron-icon>
                GitHub
              </paper-button>
            </template>
          </nav>

          <template is="dom-if" if="[[availableProviders.password]]">
            <div id="password-login">
              <iron-form>
                <form on-submit="signInWithEmailAndPassword" onkeyup="[[_submitOnEnter]]">
                  <paper-input value="{{userEmail}}"
                               class="m-b-1"
                               disabled="[[disabled]]"
                               type="email"
                  ></paper-input>
                  <paper-input value="{{userPassword}}"
                               class="m-b-1"
                               id="login-input-pass"
                               label="[[labelPassSignIn]]"
                               type="password"
                  ></paper-input>

                  <a href on-click="_forgotPass">Forgot Your Password?</a>

                  <paper-button class="email" on-tap="signInWithEmailAndPassword">
                    <span>Sign In</span>
                  </paper-button>
                </form>
              </iron-form>
            </div>
          </template>

          <paper-button class="email" on-tap="_closeDialog">
            <span>Cancel</span>
          </paper-button>
        </div>
      </template>

      <!--
        Recover password screen
      -->
      <template is="dom-if" if="[[email]]">
        <div name="forgot-pass">
          <iron-form id="forgot-pass-form">
            <form>
              <h3>Recover password</h3>
              <p>Get instructions sent to this email that explain how to reset your password</p>

              <paper-input value="{{userEmail}}"
                           class="m-b-1"
                           type="text"
              ></paper-input>

              <paper-button class="email" on-tap="passwordReset">
                <span>Send</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>

      <!--
        Email sent verification screen
      -->
      <template is="dom-if" if="[[email]]">
        <div name="email-sent">
          <h3>Check your email</h3>

          <p>Follow the instructions sent to <strong>[[userEmail]]</strong> to recover your password.</p>

          <paper-button class="email" on-tap="_chooseEmail">
            <span>Done</span>
          </paper-button>
        </div>
      </template>

      <!--
        Email Sign-up screen
      -->
      <template is="dom-if" if="[[email]]">
        <div name="email-signup">
          <iron-form id="email-signup-form">
            <form on-submit="createUserWithEmailAndPassword" onkeyup="[[_submitOnEnter]]">
              <paper-input value="{{userEmail}}"
                           class="m-b-1"
                           disabled="[[disabled]]"
                           id="signup-input-email"
                           type="email"
              ></paper-input>

              <paper-input value="{{userName}}"
                           auto-validate$="[[userName]]"
                           class="m-b-1"
                           id="signup-input-name"
                           label="First & last name"
                           required
                           type="text"
              ></paper-input>

              <paper-input value="{{userPassword}}"
                           auto-validate$="[[userPassword]]"
                           class="m-b-1"
                           error-message="[[errorMessagePass]]"
                           id="signup-input-pass"
                           label="[[labelPassSignUp]]"
                           minlength="[[minLength]]"
                           required
                           type="password"
              ></paper-input>

              <paper-button class="email" on-tap="createUserWithEmailAndPassword">
                <span>Sign Up</span>
              </paper-button>
              <paper-button class="email" on-tap="_closeDialog">
                <span>Cancel</span>
              </paper-button>
            </form>
          </iron-form>
        </div>
      </template>
    </iron-pages>
  </template>

  <script>
    /**
     * `skeleton-auth`
     * Minimal Sign in module using polymer and firebase
     *
     * @customElement
     * @polymer
     * @constructor
     * @appliesMixin Fabric.AuthMixin
     * @extends Polymer.Element
     * @property {boolean} google
     * @demo demo/index.html
     * */
    class SkeletonAuth extends Fabric.AuthMixin(Polymer.Element) {
      /**
       * @return {string}
       */
      static get is() {
        return 'skeleton-auth';
      }

      /**
       * Call to close the email dialog
       *
       * @private
       */
      _closeDialog() {
        this.clear();
        this.selected = 'options';
      }
    }

    window.customElements.define(SkeletonAuth.is, SkeletonAuth);
  </script>

</dom-module>
